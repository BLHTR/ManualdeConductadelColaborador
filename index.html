<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curso BlatoRH Group - Manual de Conducta del Colaborador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700;800&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); box-shadow: 0 0 12px rgba(251, 191, 36, 0.5); }
            50% { transform: scale(1.03); box-shadow: 0 0 24px rgba(251, 191, 36, 0.8); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a192f;
            color: #e6f1ff;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
        }
        .app-container {
            width: 100%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .card {
            background-color: rgba(17, 34, 64, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(136, 146, 176, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: all 0.3s ease;
            animation: fadeIn 0.6s ease-out forwards;
        }
        .btn { @apply font-bold py-3 px-6 rounded-lg transition-all duration-300 ease-in-out transform focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900; }
        .btn-primary { @apply bg-amber-400 text-slate-900 hover:bg-amber-300 focus:ring-amber-400 shadow-lg shadow-amber-500/20; }
        .btn-primary:disabled { @apply bg-amber-800 text-slate-400 cursor-not-allowed transform-none shadow-none; }
        .btn-secondary { @apply bg-slate-700 text-white hover:bg-slate-600 focus:ring-slate-500; }
        .pulsing-button { animation: pulse-glow 2.5s infinite ease-in-out; }
        .input-field {
            background-color: #1e293b;
            border: 2px solid #334155;
            color: #e2e8f0;
            @apply mt-2 block w-full px-4 py-3 rounded-lg shadow-sm transition-all duration-300;
        }
        .input-field:focus { @apply outline-none ring-2 ring-amber-400 border-amber-400 bg-slate-900; }
        .progress-bar-container { @apply w-full bg-slate-700 rounded-full h-3 overflow-hidden; }
        .progress-bar { @apply bg-amber-400 h-3 rounded-full transition-all duration-500 ease-out; }
        #chapter-content { max-height: 55vh; overflow-y: auto; padding-right: 1rem; scroll-behavior: smooth; }
        #chapter-content::-webkit-scrollbar { width: 8px; }
        #chapter-content::-webkit-scrollbar-track { background: #1e293b; border-radius: 10px; }
        #chapter-content::-webkit-scrollbar-thumb { background: #fbbF24; border-radius: 10px; }
        #chapter-content::-webkit-scrollbar-thumb:hover { background: #f59e0b; }
        .quiz-option {
            background-color: #1e293b;
            border: 2px solid #334155;
            @apply flex items-center w-full text-left p-4 rounded-lg cursor-pointer hover:bg-slate-700 hover:border-amber-400 transition-all duration-200 transform hover:scale-102;
        }
        .quiz-option.selected { border-color: #fbbF24; background-color: #334155; transform: scale(1.02); }
        .hidden { display: none; }
        .screen { width: 100%; }

        /* Login Screen Styles */
        .login-grid { display: grid; grid-template-columns: 1fr; min-height: 100vh; }
        @media (min-width: 1024px) { .login-grid { grid-template-columns: 1fr 1fr; } }
        .login-promo { background: linear-gradient(-45deg, #0a192f, #172a46, #4a0e99, #23d5ab); background-size: 400% 400%; animation: gradient-animation 15s ease infinite; padding: 2rem; }
        
        /* Audio Settings Panel Styles */
        #audio-settings-panel {
            position: absolute;
            top: 100%;
            right: 0;
            width: 300px;
            background-color: #0a192f;
            border: 1px solid #334155;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 100;
            padding: 1rem;
            border-radius: 0.5rem;
            transform-origin: top right;
            transform: scale(0.95);
            opacity: 0;
            visibility: hidden;
            transition: transform 0.15s ease-out, opacity 0.15s ease-out, visibility 0s 0.15s;
        }
        #audio-settings-panel.open {
            transform: scale(1);
            opacity: 1;
            visibility: visible;
            transition: transform 0.15s ease-out, opacity 0.15s ease-out;
        }
        .settings-label { @apply block text-sm font-medium text-slate-300 mb-2; }
        .settings-select, .settings-range {
             background-color: #1e293b;
             border: 1px solid #334155;
             color: #e2e8f0;
             @apply w-full p-2 rounded-md;
        }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #fbbF24; cursor: pointer; border-radius: 50%; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: #fbbF24; cursor: pointer; border-radius: 50%; }
        #audio-progress-container { @apply w-full bg-slate-700 rounded-full h-2 overflow-hidden mt-3; }
        #audio-progress-bar { @apply bg-green-500 h-2 rounded-full transition-all duration-100 ease-linear; width: 0%; }
    
        /* === ESTILOS DEL DIPLOMA === */
        #diploma-content {
            position: relative;
            background: #fdfbf4; 
            color: #3a2d0d;
            border: 8px solid #c7a75b;
            border-radius: 10px;
            padding: 1rem;
            aspect-ratio: 1.414 / 1; 
            max-width: 100%;
            box-shadow: 0 0 18px rgba(0,0,0,.4);
            overflow: hidden;
        }
        #diploma-content::after {
            content: "";
            position: absolute;
            inset: 14px;
            border: 1.5px solid rgba(199,167,91,.55);
            border-radius: 8px;
            pointer-events: none;
        }
        .diploma-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 70%;
            height: auto;
            transform: translate(-50%, -50%) rotate(-18deg);
            opacity: 0.08;
            z-index: 0;
            pointer-events: none;
        }
        .diploma-inner {
            position: relative;
            z-index: 1;
            height: 100%;
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: .25rem;
        }
        .diploma-heading { text-align: center; padding: .25rem 0; }
        .diploma-subtitle {
            font-family: 'Merriweather', serif;
            text-transform: uppercase;
            letter-spacing: .08em;
            font-size: clamp(.9rem, 1.6vw, 1.05rem);
            color: #705714;
        }
        .diploma-title {
            font-family: 'Playfair Display', serif;
            font-weight: 800;
            color: #8c6b22;
            line-height: 1.05;
            font-size: clamp(2.4rem, 5.4vw, 3.6rem);
            margin: .15rem 0;
        }
        .diploma-body {
            display: grid;
            place-items: center;
            text-align: center;
            padding-inline: 1.2rem;
        }
        .diploma-line {
            font-family: 'Merriweather', serif;
            color: #4a3b17;
            font-size: clamp(1rem, 2vw, 1.1rem);
            margin: .2rem 0;
        }
        .diploma-name {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: clamp(1.6rem, 3.4vw, 2.2rem);
            color: #2e250c;
            padding: .25rem .75rem;
            border-bottom: 2px solid rgba(140,107,34,.35);
            display: inline-block;
            margin: .35rem 0 .5rem;
        }
        .diploma-course {
            font-weight: 700;
            font-family: 'Merriweather', serif;
            font-size: clamp(1.15rem, 2.4vw, 1.35rem);
            color: #3a2d0d;
            margin: .25rem 0 .4rem;
        }
        .diploma-date {
            font-weight: 700;
            font-family: 'Merriweather', serif;
            font-size: clamp(1rem, 2vw, 1.15rem);
            color: #5a4717;
        }
        .diploma-footer {
            min-height: 64px;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
            padding: 0 .75rem .75rem 0;
        }
        .diploma-seal-container {
            position: absolute;
            right: 1.1rem;
            bottom: 1rem;
            width: 92px;
            height: 92px;
            pointer-events: none;
        }
        .diploma-seal-container svg {
            width: 100%;
            height: 100%;
        }

        @media (max-width: 640px) {
            .diploma-seal-container {
                width: 76px;
                height: 76px;
                right: .7rem;
                bottom: .7rem;
            }
        }
</style>
</head>
<body class="antialiased">
    
    <header id="app-header" class="w-full max-w-5xl mx-auto p-4 md:p-6 hidden">
        <div class="flex items-center space-x-3">
            <svg class="h-10 w-10 text-amber-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.008h-.008v-.008z" />
            </svg>
            <span class="text-2xl font-bold text-white">BlatoRH Group</span>
        </div>
    </header>

    <main class="app-container">
        <div class="main-content-area w-full">

            <div id="diploma-loading" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
                <div class="text-center p-6 bg-slate-800 rounded-xl">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-amber-500 mx-auto mb-4"></div>
                    <p class="text-white">Generando diploma...</p>
                </div>
            </div>

            <div id="message-box" class="fixed top-5 left-1/2 -translate-x-1/2 mt-4 p-4 rounded-lg shadow-lg text-white z-50 hidden" role="alert">
                <span id="message-text"></span>
                <button onclick="document.getElementById('message-box').classList.add('hidden')" class="ml-4 font-bold">&times;</button>
            </div>
            
            <div id="login-screen" class="screen w-full min-h-screen">
                <div class="login-grid">
                     <div class="login-promo hidden lg:flex flex-col justify-center items-start p-12">
                         <img src="https://raw.githubusercontent.com/BLHTR/CursoSeguridad/main/blatorh.png" alt="BlatoRH Logo" class="h-16 w-auto mb-8" onerror="this.src='https://placehold.co/200x64/FFFFFF/0a192f?text=BlatoRH'; this.onerror=null;">
                         <h1 id="login-course-title" class="text-5xl font-bold text-white leading-tight mt-4"></h1>
                         <p class="text-slate-300 mt-4 text-lg">Este manual establece las normas de conducta y los principios éticos que todos los colaboradores de BlatoRH Group deben seguir.</p>
                     </div>
                     <div class="flex flex-col justify-center items-center p-8 bg-slate-900/50 relative">
                         <div id="settings-container" class="absolute top-4 right-4">
                             <button id="hamburger-btn" class="p-2 rounded-md hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-amber-400">
                                 <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                             </button>
                             <div id="audio-settings-panel">
                                 <div class="flex justify-between items-center mb-4">
                                     <h3 class="text-lg font-bold text-white">Configuración de Voz</h3>
                                 </div>
                                 <div class="space-y-4">
                                     <div>
                                         <label for="voice-select" class="settings-label">Voz</label>
                                         <select id="voice-select" class="settings-select"></select>
                                     </div>
                                     <div>
                                         <label for="voice-speed" class="settings-label">Velocidad: <span id="voice-speed-value">1x</span></label>
                                         <input type="range" id="voice-speed" class="settings-range" min="0.8" max="1.5" step="0.1" value="1">
                                     </div>
                                     <div>
                                         <label for="voice-volume" class="settings-label">Volumen: <span id="voice-volume-value">100%</span></label>
                                         <input type="range" id="voice-volume" class="settings-range" min="0" max="1" step="0.1" value="1">
                                     </div>
                                 </div>
                                 <div class="flex items-center space-x-2 mt-4">
                                     <button id="preview-voice-btn" class="btn btn-secondary flex-1 flex items-center justify-center space-x-2">
                                         <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 0 1 1-1h2a1 1 0 1 1 0 2H9a1 1 0 0 1-1-1z" /><path d="M5.5 4.5A2.5 2.5 0 0 0 3 7v6a2.5 2.5 0 0 0 2.5 2.5h9A2.5 2.5 0 0 0 17 13V7a2.5 2.5 0 0 0-2.5-2.5h-9zM7 7a1 1 0 0 1 1-1h4a1 1 0 1 1 0 2H8a1 1 0 0 1-1-1z" /></svg>
                                         <span>Probar</span>
                                     </button>
                                     <button id="save-settings-btn" class="btn btn-primary flex-1 flex items-center justify-center space-x-2">
                                         <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v10l-5-5-5 5V4z" /></svg>
                                         <span>Guardar</span>
                                     </button>
                                 </div>
                             </div>
                         </div>

                         <div class="w-full max-w-md">
                              <div class="text-center lg:hidden mb-8">
                                 <h2 class="text-3xl md:text-4xl font-bold text-white">BlatoRH Group</h2>
                                 <p id="login-course-title-mobile" class="mt-2 text-slate-300"></p>
                              </div>
                             <p class="text-center text-slate-300 mb-2">Ingresa tus datos para comenzar.</p>
                             <div class="text-center mb-6">
                                 <div class="inline-flex items-center bg-slate-800/50 px-3 py-1.5 rounded-full text-sm">
                                     <svg class="w-5 h-5 mr-2 text-amber-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>
                                     <span id="course-duration-estimate"></span>
                                 </div>
                             </div>
                             <form id="login-form" class="space-y-6">
                                 <div>
                                     <label for="name" class="block text-sm font-medium text-slate-300">Nombre</label>
                                     <input type="text" id="name" class="input-field" required>
                                 </div>
                                 <div>
                                     <label for="surname" class="block text-sm font-medium text-slate-300">Apellido</label>
                                     <input type="text" id="surname" class="input-field" required>
                                 </div>
                                 <div>
                                     <label for="email" class="block text-sm font-medium text-slate-300">Email Corporativo</label>
                                     <input type="email" id="email" class="input-field" required pattern=".*@blatorh\.com$">
                                 </div>
                                 <button type="submit" id="login-submit-btn" class="btn btn-primary w-full !mt-8 pulsing-button">
                                     <span class="btn-text">Ingresar al Curso</span>
                                     <span class="btn-loader hidden animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-slate-900 mx-auto"></span>
                                 </button>
                             </form>
                         </div>
                     </div>
                </div>
            </div>

            <div id="course-screen" class="card screen hidden w-full max-w-3xl mx-auto p-6 md:p-8">
                <div class="mb-6">
                    <p id="chapter-number" class="text-amber-400 font-semibold"></p>
                    <h2 id="chapter-title" class="text-3xl md:text-4xl font-bold mt-1"></h2>
                </div>
                <div class="progress-bar-container mb-6">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
                <div id="chapter-content" class="prose prose-invert max-w-none text-slate-300 text-lg leading-relaxed"></div>
                <div class="flex flex-col sm:flex-row justify-between items-center mt-8 border-t border-slate-700 pt-6 space-y-4 sm:space-y-0">
                    <div class="w-full sm:w-auto">
                        <button id="listen-btn" class="btn btn-secondary w-full">Escuchar Audio</button>
                        <div id="audio-progress-container" class="hidden">
                            <div id="audio-progress-bar"></div>
                        </div>
                    </div>
                    <button id="next-btn" class="btn btn-primary w-full sm:w-auto" disabled>Siguiente</button>
                </div>
            </div>

            <div id="quiz-screen" class="card screen hidden w-full max-w-2xl mx-auto p-6 md:p-8">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold">Evaluación Final</h2>
                    <p class="text-slate-300 mt-1">Demuestra lo que has aprendido.</p>
                </div>
                <div class="progress-bar-container my-6">
                    <div id="quiz-progress-bar" class="progress-bar"></div>
                </div>
                <div id="quiz-content" class="min-h-[30vh]"></div>
                <div id="quiz-navigation" class="flex justify-between items-center mt-8">
                    <button id="prev-question-btn" class="btn btn-secondary">Anterior</button>
                    <button id="next-question-btn" class="btn btn-primary">Siguiente</button>
                </div>
                 <button id="submit-quiz-btn" class="btn btn-primary w-full mt-8 hidden">Finalizar y Ver Resultados</button>
            </div>
            
            <div id="result-screen" class="card screen hidden text-center w-full max-w-md mx-auto p-6 md:p-8">
                 <h2 class="text-3xl font-bold mb-4">Resultados</h2>
                 <p class="text-6xl font-bold mb-4" id="result-score"></p>
                 <p class="text-xl mb-8" id="result-message"></p>
                 <div id="result-summary" class="space-y-2 text-left max-w-md mx-auto mb-8"></div>
                 <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                     <button id="restart-quiz-btn" class="btn btn-secondary">Reintentar</button>
                     <button id="diploma-btn" class="btn btn-primary hidden">Ver Diploma</button>
                 </div>
            </div>

            <div id="diploma-screen" class="card screen hidden w-full max-w-4xl mx-auto p-6 md:p-8">
                <h2 class="text-3xl font-bold mb-6 text-center">¡Felicitaciones, has completado el curso!</h2>
                <div id="diploma-content-wrapper" class="p-2 bg-slate-800 rounded-lg">
                    <div id="diploma-content">
                        <img src="https://raw.githubusercontent.com/BLHTR/CursoSeguridad/main/blatorh.png" class="diploma-watermark" alt="">
                        
                        <div class="diploma-inner">
                            <header class="diploma-heading">
                                <div class="diploma-subtitle">Certificado de Finalización</div>
                                <h1 class="diploma-title">DIPLOMA</h1>
                            </header>

                            <section class="diploma-body">
                                <div>
                                    <p class="diploma-line">Este certificado es otorgado a:</p>
                                    <p id="diploma-participant-name" class="diploma-name"></p>

                                    <p class="diploma-line">Por haber completado exitosamente el curso:</p>
                                    <p id="diploma-course-title" class="diploma-course">""</p>

                                    <p class="diploma-line">Otorgado en la fecha:</p>
                                    <p id="diploma-date" class="diploma-date"></p>
                                </div>
                            </section>

                            <footer class="diploma-footer">
                                <div class="diploma-seal-container">
                                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                        <defs>
                                            <radialGradient id="goldGradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                                                <stop offset="0%" stop-color="#d4af37" />
                                                <stop offset="100%" stop-color="#b48811" />
                                            </radialGradient>
                                            <filter id="dropShadow" x="-20%" y="-20%" width="140%" height="140%">
                                                <feGaussianBlur in="SourceAlpha" stdDeviation="2.5" result="blur" />
                                                <feOffset in="blur" dy="1" result="offsetBlur" />
                                                <feComponentTransfer in="offsetBlur" result="shadowOpacity">
                                                    <feFuncA type="linear" slope="0.6" />
                                                </feComponentTransfer>
                                                <feMerge>
                                                    <feMergeNode in="shadowOpacity" />
                                                    <feMergeNode in="SourceGraphic" />
                                                </feMerge>
                                            </filter>
                                        </defs>
                                        <circle cx="50" cy="50" r="48" fill="url(#goldGradient)" filter="url(#dropShadow)" />
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="2.5" />
                                        <text font-family="'Merriweather', serif" font-weight="800" font-size="12" fill="white" text-anchor="middle" style="text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                                            <tspan x="50" y="46">CURSO</tspan>
                                            <tspan x="50" y="61">APROBADO</tspan>
                                        </text>
                                    </svg>
                                </div>
                            </footer>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row justify-center mt-8 space-y-4 sm:space-y-0 sm:space-x-4">
                    <button id="download-diploma-btn" class="btn btn-primary">Descargar Diploma (PDF)</button>
                    <button onclick="downloadResourcePdf()" class="btn btn-secondary">Descargar Material (PDF)</button>
                    <button id="restart-course-btn" class="btn btn-secondary">Reiniciar Curso</button>
                </div>
            </div>

            <div id="admin-panel" class="card screen hidden w-full max-w-4xl mx-auto p-6 md:p-8">
                 <h2 class="text-2xl font-bold mb-6 text-center">Panel de Administración</h2>
                 <button id="export-csv-btn" class="btn btn-primary mb-4">Exportar Aprobados (CSV)</button>
                 <div class="overflow-x-auto">
                     <table class="min-w-full bg-slate-800 rounded-lg shadow-md">
                         <thead class="bg-slate-700 text-slate-300 uppercase text-sm leading-normal">
                             <tr>
                                 <th class="py-3 px-6 text-left">Nombre</th>
                                 <th class="py-3 px-6 text-left">Apellido</th>
                                 <th class="py-3 px-6 text-left">Email</th>
                                 <th class="py-3 px-6 text-left">Score</th>
                                 <th class="py-3 px-6 text-left">Fecha</th>
                             </tr>
                         </thead>
                         <tbody id="approved-users-table-body" class="text-slate-400 text-sm font-light"></tbody>
                     </table>
                 </div>
            </div>
        </div>
    </main>

    <script>
        // --- CONFIGURACIÓN ---
        const SUPABASE_URL = 'https://zaxyokejvwupwmbhenso.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpheHlva2Vqdnd1cHdtYmhlbnNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NzMwNDYsImV4cCI6MjA2ODQ0OTA0Nn0.boNwgjYadjo6deO_YfKbLCGt0ug4H012D2KuhX0WZB8';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const COURSE_TITLE = "Manual de Conducta del Colaborador";
        const RESOURCE_PDF_URL = 'https://raw.githubusercontent.com/BLHTR/ManualdeConductadelColaborador/main/Manual%20de%20Conducta%20del%20Colaborador.pdf';

        // --- DATOS DEL CURSO ---
        const chapters = [
            { title: "Alcance y Principios Fundamentales", content: `<p><strong>Definición de Alcance:</strong> Este manual establece los principios mínimos de conducta para todos los colaboradores de BlatoRH Group en cualquier circunstancia.</p><p class="mt-4"><strong>A quiénes aplica:</strong> El término "Colaboradores" incluye a todas las personas vinculadas a la empresa, ya sean directores, asesores, empleados, contratistas y proveedores. Todos deben actuar conforme a este manual.</p><p class="mt-4"><strong>Relación con el Contrato:</strong> El manual complementa el contrato legal con el empleado. En caso de conflicto entre ambos documentos, las disposiciones del Contrato prevalecerán.</p>` },
            { title: "Integridad, Honestidad y Lucha Contra la Corrupción", content: `<p><strong>Conducta Ética:</strong> Se exige actuar siempre con integridad y mantener los más altos estándares éticos. Esto implica cumplir con todas las leyes y regulaciones aplicables.</p><p class="mt-4"><strong>Política Anti-Soborno:</strong> BlatoRH Group tiene una política de tolerancia cero hacia cualquier forma de soborno o corrupción.</p><p class="mt-4"><strong>Prohibiciones:</strong> Está estrictamente prohibido ofrecer, prometer o pagar dinero, regalos o cualquier otro beneficio a personas o entidades (públicas o privadas) para obtener ventajas ilícitas. Los "pagos de facilitación" también están prohibidos.</p>` },
            { title: "Conflicto de Intereses y Sostenibilidad", content: `<p><strong>Declaración de Conflictos:</strong> Los empleados tienen la obligación de revelar cualquier conflicto de intereses, ya sea real o potencial, que surja de relaciones comerciales o personales.</p><p class="mt-4"><strong>Compromiso Ambiental:</strong> Es fundamental operar con cuidado hacia el medio ambiente, respetando toda la legislación ambiental vigente y obteniendo las licencias necesarias.</p>` },
            { title: "Confidencialidad y Protección de Datos", content: `<p><strong>Secreto Profesional:</strong> Los empleados deben proteger toda la información personal, confidencial y propiedad de BlatoRH Group.</p><p class="mt-4"><strong>Uso de la Información:</strong> Está prohibido revelar información confidencial a terceros no autorizados o utilizarla para intereses personales.</p><p class="mt-4"><strong>Protección de Datos:</strong> Se deben conocer y aplicar las regulaciones de protección de datos de Argentina y las políticas internas de BlatoRH Group. Los datos personales no deben ser divulgados fuera de la empresa.</p>` },
            { title: "Cumplimiento y Consecuencias", content: `<p><strong>Obligación de Cumplimiento:</strong> Todos los colaboradores de BlatoRH Group deben cumplir rigurosamente con este manual.</p><p class="mt-4"><strong>Consecuencias del Incumplimiento:</strong> No seguir los principios establecidos en este manual puede resultar en la terminación del contrato por justa causa.</p><p class="mt-4"><strong>Responsabilidad Adicional:</strong> Además de la terminación del contrato, el incumplimiento puede acarrear multas y la obligación de indemnizar a BlatoRH Group por las pérdidas y daños ocasionados.</p>` }
        ];

        const quizQuestions = [
            { question: "¿A quiénes aplica el Manual de Conducta de BlatoRH Group?", options: ["Solo a los directores.", "Solo a los empleados de tiempo completo.", "A todos los colaboradores, incluyendo directores, empleados, contratistas y proveedores.", "Solo a los clientes."], answer: 2 },
            { question: "¿Cuál es la política de BlatoRH Group respecto al soborno y la corrupción?", options: ["Se permite en ciertas circunstancias.", "No se tolera ninguna forma de soborno o corrupción.", "Solo se prohíbe el soborno a funcionarios públicos.", "Es aceptable si es una práctica común en el país."], answer: 1 },
            { question: "¿Qué debe hacer un empleado si identifica un posible conflicto de intereses?", options: ["Ignorarlo si no parece grave.", "Intentar resolverlo por su cuenta.", "Revelarlo inmediatamente a la empresa.", "Consultarlo con un compañero de trabajo."], answer: 2 },
            { question: "Según el manual, ¿está permitido usar información confidencial de un cliente para beneficio personal?", options: ["Sí, si el beneficio es pequeño.", "No, está estrictamente prohibido.", "Solo con autorización de un supervisor.", "Sí, si la información ya es parcialmente pública."], answer: 1 },
            { question: "¿Cuál es la principal consecuencia para un empleado que incumple el Manual de Conducta?", options: ["Una advertencia verbal.", "La suspensión temporal.", "La terminación del contrato por justa causa.", "Un curso de re-capacitación obligatorio."], answer: 2 }
        ];
        
        // --- ELEMENTOS DEL DOM ---
        const domElements = {
            appHeader: document.getElementById('app-header'),
            screens: { login: document.getElementById('login-screen'), course: document.getElementById('course-screen'), quiz: document.getElementById('quiz-screen'), result: document.getElementById('result-screen'), diploma: document.getElementById('diploma-screen'), admin: document.getElementById('admin-panel'), },
            loginForm: document.getElementById('login-form'), loginSubmitBtn: document.getElementById('login-submit-btn'), nameInput: document.getElementById('name'), surnameInput: document.getElementById('surname'), emailInput: document.getElementById('email'), loginCourseTitle: document.getElementById('login-course-title'), loginCourseTitleMobile: document.getElementById('login-course-title-mobile'), courseDurationEstimate: document.getElementById('course-duration-estimate'),
            chapterNumber: document.getElementById('chapter-number'), progressBar: document.getElementById('progress-bar'), chapterTitle: document.getElementById('chapter-title'), chapterContent: document.getElementById('chapter-content'), listenBtn: document.getElementById('listen-btn'), nextBtn: document.getElementById('next-btn'),
            quizProgressBar: document.getElementById('quiz-progress-bar'), quizContent: document.getElementById('quiz-content'), prevQuestionBtn: document.getElementById('prev-question-btn'), nextQuestionBtn: document.getElementById('next-question-btn'), submitQuizBtn: document.getElementById('submit-quiz-btn'),
            resultScore: document.getElementById('result-score'), resultMessage: document.getElementById('result-message'), resultSummary: document.getElementById('result-summary'), restartQuizBtn: document.getElementById('restart-quiz-btn'), diplomaBtn: document.getElementById('diploma-btn'),
            diplomaCourseTitle: document.getElementById('diploma-course-title'), diplomaParticipantName: document.getElementById('diploma-participant-name'), diplomaDate: document.getElementById('diploma-date'), downloadDiplomaBtn: document.getElementById('download-diploma-btn'), restartCourseBtn: document.getElementById('restart-course-btn'),
            exportCsvBtn: document.getElementById('export-csv-btn'), approvedUsersTableBody: document.getElementById('approved-users-table-body'),
            messageBox: document.getElementById('message-box'), messageText: document.getElementById('message-text'), diplomaLoading: document.getElementById('diploma-loading'),
            // Audio Elements
            hamburgerBtn: document.getElementById('hamburger-btn'), audioSettingsPanel: document.getElementById('audio-settings-panel'), voiceSelect: document.getElementById('voice-select'), voiceSpeed: document.getElementById('voice-speed'), voiceSpeedValue: document.getElementById('voice-speed-value'), voiceVolume: document.getElementById('voice-volume'), voiceVolumeValue: document.getElementById('voice-volume-value'),
            previewVoiceBtn: document.getElementById('preview-voice-btn'), saveSettingsBtn: document.getElementById('save-settings-btn'), 
            audioProgressContainer: document.getElementById('audio-progress-container'), audioProgressBar: document.getElementById('audio-progress-bar'),
        };

        // --- ESTADO DE LA APLICACIÓN ---
        let state = {
            currentUser: null,
            currentChapterIndex: 0,
            currentQuestionIndex: 0,
            userAnswers: new Array(quizQuestions.length).fill(null),
            utterance: null,
            autoPlayTimeout: null,
            audioSettings: { voiceURI: 'default', rate: 1, volume: 1, },
            availableVoices: [],
        };

        // --- FUNCIONES PRINCIPALES ---
        function showScreen(screenName) {
            Object.values(domElements.screens).forEach(screen => screen && screen.classList.add('hidden'));
            if (domElements.screens[screenName]) domElements.screens[screenName].classList.remove('hidden');
            domElements.appHeader.classList.toggle('hidden', screenName === 'login' || screenName === 'admin');
        }

        function showMessage(message, type = 'success') {
            domElements.messageText.textContent = message;
            domElements.messageBox.className = `fixed top-5 left-1/2 -translate-x-1/2 mt-4 p-4 rounded-lg shadow-lg text-white z-50 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            domElements.messageBox.classList.remove('hidden');
            setTimeout(() => domElements.messageBox.classList.add('hidden'), 5000);
        }

        async function saveUserProgressToSupabase(user) {
            const { error } = await supabaseClient.from('users_progress').upsert(user, { onConflict: 'id' });
            if (error) console.error('Error guardando progreso:', error.message);
        }

        function updateProgressBar() {
            const progress = ((state.currentChapterIndex + 1) / chapters.length) * 100;
            domElements.progressBar.style.width = `${progress}%`;
            if (state.currentUser) {
                state.currentUser.progress = state.currentChapterIndex;
                saveUserProgressToSupabase(state.currentUser);
            }
        }
        
        function calculateCourseDuration() {
            const totalWords = chapters.reduce((acc, chapter) => acc + chapter.content.replace(/<[^>]*>/g, '').split(/\s+/).length, 0);
            return Math.ceil(totalWords / 180) + Math.ceil(quizQuestions.length * 0.75);
        }
        
        function loadChapter() {
            if (state.autoPlayTimeout) clearTimeout(state.autoPlayTimeout);
            stopAudio();

            if (state.currentChapterIndex < chapters.length) {
                const chapter = chapters[state.currentChapterIndex];
                domElements.chapterNumber.textContent = `Capítulo ${state.currentChapterIndex + 1} de ${chapters.length}`;
                domElements.chapterTitle.textContent = chapter.title;
                domElements.chapterContent.innerHTML = chapter.content;
                domElements.nextBtn.disabled = true;
                domElements.nextBtn.classList.remove('pulsing-button');
                updateProgressBar();
                state.autoPlayTimeout = setTimeout(handleListen, 6000);
            } else {
                startQuiz();
            }
        }

        // --- AUDIO FUNCTIONS ---
        function unlockAudio() {
            const synth = window.speechSynthesis;
            if (synth.speaking || synth.pending) return;
            const unlockUtterance = new SpeechSynthesisUtterance('');
            unlockUtterance.volume = 0;
            synth.speak(unlockUtterance);
            synth.cancel();
        }

        function initAudioSystem() {
            if ('speechSynthesis' in window) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
                populateVoiceList(); 
                loadAudioSettings();
                domElements.hamburgerBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    domElements.audioSettingsPanel.classList.toggle('open');
                });
                domElements.previewVoiceBtn.addEventListener('click', previewVoice);
                domElements.saveSettingsBtn.addEventListener('click', saveAudioSettings);
                domElements.voiceSpeed.addEventListener('input', (e) => { domElements.voiceSpeedValue.textContent = `${Number(e.target.value).toFixed(1)}x`; });
                domElements.voiceVolume.addEventListener('input', (e) => { domElements.voiceVolumeValue.textContent = `${Math.round(e.target.value * 100)}%`; });
                document.body.addEventListener('click', (e) => {
                    if (!domElements.audioSettingsPanel.contains(e.target) && !domElements.hamburgerBtn.contains(e.target)) {
                        domElements.audioSettingsPanel.classList.remove('open');
                    }
                });
            } else {
                domElements.hamburgerBtn.style.display = 'none';
                domElements.listenBtn.style.display = 'none';
            }
        }

        function populateVoiceList() {
            if (state.availableVoices.length > 0 && domElements.voiceSelect.options.length > 1) return;
            const allVoices = window.speechSynthesis.getVoices();
            state.availableVoices = allVoices.filter(voice => voice.lang.startsWith('es'));
            
            domElements.voiceSelect.innerHTML = state.availableVoices.length ? '' : '<option>No hay voces en español</option>';
            
            let defaultVoiceURI = state.availableVoices[0]?.voiceURI;
            if(!localStorage.getItem('blatorh_audio_settings')) {
                const priorityOrder = ['es-AR', 'es-MX', 'es-ES'];
                for(const lang of priorityOrder) {
                    const found = state.availableVoices.find(v => v.lang === lang);
                    if(found) { defaultVoiceURI = found.voiceURI; break; }
                }
            }

            state.availableVoices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.voiceURI;
                domElements.voiceSelect.appendChild(option);
            });
            
            state.audioSettings.voiceURI = localStorage.getItem('blatorh_audio_settings') ? JSON.parse(localStorage.getItem('blatorh_audio_settings')).voiceURI : defaultVoiceURI;
            if(state.audioSettings.voiceURI) domElements.voiceSelect.value = state.audioSettings.voiceURI;
        }

        function loadAudioSettings() {
            const savedSettings = JSON.parse(localStorage.getItem('blatorh_audio_settings'));
            if (savedSettings) state.audioSettings = savedSettings;
            if(domElements.voiceSelect.options.length > 0 && state.audioSettings.voiceURI) domElements.voiceSelect.value = state.audioSettings.voiceURI;
            domElements.voiceSpeed.value = state.audioSettings.rate;
            domElements.voiceSpeedValue.textContent = `${Number(state.audioSettings.rate).toFixed(1)}x`;
            domElements.voiceVolume.value = state.audioSettings.volume;
            domElements.voiceVolumeValue.textContent = `${Math.round(state.audioSettings.volume * 100)}%`;
        }

        function previewVoice() {
            window.speechSynthesis.cancel();
            const previewUtterance = new SpeechSynthesisUtterance(COURSE_TITLE);
            const selectedVoiceURI = domElements.voiceSelect.value;
            previewUtterance.voice = state.availableVoices.find(v => v.voiceURI === selectedVoiceURI) || null;
            previewUtterance.rate = parseFloat(domElements.voiceSpeed.value);
            previewUtterance.volume = parseFloat(domElements.voiceVolume.value);
            window.speechSynthesis.speak(previewUtterance);
        }
        
        function saveAudioSettings() {
            state.audioSettings.voiceURI = domElements.voiceSelect.value;
            state.audioSettings.rate = parseFloat(domElements.voiceSpeed.value);
            state.audioSettings.volume = parseFloat(domElements.voiceVolume.value);
            localStorage.setItem('blatorh_audio_settings', JSON.stringify(state.audioSettings));
            domElements.audioSettingsPanel.classList.remove('open');
            showMessage('Configuración de voz guardada.', 'success');
            if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();
        }
        
        function handleListen() {
            if (state.autoPlayTimeout) clearTimeout(state.autoPlayTimeout);
            
            const synth = window.speechSynthesis;
            if (synth.paused) {
                synth.resume();
                domElements.listenBtn.textContent = "Pausar Audio";
            } else if (synth.speaking) {
                synth.pause();
                domElements.listenBtn.textContent = "Reanudar Audio";
            } else {
                playAudio();
            }
        }
        
        function playAudio() {
            const fullText = domElements.chapterTitle.textContent + ". " + domElements.chapterContent.innerText;
            state.utterance = new SpeechSynthesisUtterance(fullText);
            
            loadAudioSettings(); 
            state.utterance.voice = state.availableVoices.find(v => v.voiceURI === state.audioSettings.voiceURI) || null;
            state.utterance.rate = state.audioSettings.rate;
            state.utterance.volume = state.audioSettings.volume;

            state.utterance.onboundary = (event) => {
                if (event.name === 'word') {
                    const progress = ((event.charIndex + event.charLength) / fullText.length) * 100;
                    domElements.audioProgressBar.style.width = `${progress}%`;
                }
            };
            
            state.utterance.onend = () => {
                domElements.nextBtn.disabled = false;
                domElements.nextBtn.classList.add('pulsing-button');
                stopAudio(false); 
                domElements.audioProgressBar.style.width = '100%';
            };
            
            domElements.audioProgressContainer.classList.remove('hidden');
            domElements.audioProgressBar.style.width = '0%';
            window.speechSynthesis.speak(state.utterance);
            domElements.listenBtn.textContent = "Pausar Audio";
        }

        function stopAudio(resetProgressBar = true) {
            window.speechSynthesis.cancel();
            domElements.listenBtn.textContent = "Escuchar Audio";
            if(resetProgressBar) {
                domElements.audioProgressContainer.classList.add('hidden');
                domElements.audioProgressBar.style.width = '0%';
            }
            state.utterance = null;
        }

        // --- QUIZ & OTHER FUNCTIONS ---
        function startQuiz() {
            if (state.autoPlayTimeout) clearTimeout(state.autoPlayTimeout);
            showScreen('quiz');
            state.currentQuestionIndex = 0;
            state.userAnswers.fill(null);
            renderQuestion();
        }
        
        function renderQuestion() {
            const q = quizQuestions[state.currentQuestionIndex];
            domElements.quizContent.innerHTML = `<p class="font-semibold text-xl text-center text-slate-200 mb-8">${state.currentQuestionIndex + 1}. ${q.question}</p><div class="flex flex-col space-y-4">${q.options.map((option, index) => `<button class="quiz-option" data-answer-index="${index}"><span class="text-amber-400 font-bold mr-4">${String.fromCharCode(65 + index)}</span><span class="flex-1">${option}</span></button>`).join('')}</div>`;
            domElements.quizContent.querySelectorAll('.quiz-option').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    state.userAnswers[state.currentQuestionIndex] = parseInt(e.currentTarget.dataset.answerIndex);
                    domElements.quizContent.querySelectorAll('.quiz-option').forEach(b => b.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                    updateQuizNavigation();
                });
            });
            if (state.userAnswers[state.currentQuestionIndex] !== null) {
                const selectedBtn = domElements.quizContent.querySelector(`.quiz-option[data-answer-index="${state.userAnswers[state.currentQuestionIndex]}"]`);
                if (selectedBtn) selectedBtn.classList.add('selected');
            }
            updateQuizNavigation();
            updateQuizProgressBar();
        }

        function updateQuizNavigation() {
            domElements.prevQuestionBtn.style.visibility = state.currentQuestionIndex === 0 ? 'hidden' : 'visible';
            const isLastQuestion = state.currentQuestionIndex === quizQuestions.length - 1;
            domElements.nextQuestionBtn.classList.toggle('hidden', isLastQuestion);
            domElements.submitQuizBtn.classList.toggle('hidden', !isLastQuestion);
            const answerSelected = state.userAnswers[state.currentQuestionIndex] !== null;
            domElements.nextQuestionBtn.disabled = !answerSelected;
            domElements.submitQuizBtn.disabled = !answerSelected;
        }

        function updateQuizProgressBar() {
            domElements.quizProgressBar.style.width = `${((state.currentQuestionIndex + 1) / quizQuestions.length) * 100}%`;
        }
        
        async function submitQuiz() {
            const correctAnswers = state.userAnswers.reduce((acc, answer, index) => acc + (answer === quizQuestions[index].answer ? 1 : 0), 0);
            const score = Math.round((correctAnswers / quizQuestions.length) * 100);
            if (state.currentUser) {
                state.currentUser.quiz_score = score;
                state.currentUser.completed_date = new Date().toLocaleDateString('es-AR');
                state.currentUser.approved = score >= 80;
                await saveUserProgressToSupabase(state.currentUser);
            }
            showResultScreen(score);
        }
        
        function showResultScreen(score) {
            showScreen('result');
            domElements.resultScore.textContent = `${score}%`;
            domElements.resultMessage.textContent = score >= 80 ? '¡Excelente! Has aprobado.' : 'Necesitas repasar. ¡Inténtalo de nuevo!';
            domElements.diplomaBtn.classList.toggle('hidden', score < 80);
            domElements.resultSummary.innerHTML = quizQuestions.map((q, i) => `<div class="flex items-center text-sm ${state.userAnswers[i] === q.answer ? 'text-green-400' : 'text-red-400'}"><svg class="w-5 h-5 mr-2 shrink-0" fill="currentColor" viewBox="0 0 20 20">${state.userAnswers[i] === q.answer ? '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />' : '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />'}</svg><span>Pregunta ${i+1}: ${state.userAnswers[i] === q.answer ? 'Correcta' : 'Incorrecta'}</span></div>`).join('');
        }

        function updateDiplomaContent() {
             if (state.currentUser) {
                 domElements.diplomaCourseTitle.textContent = `"${COURSE_TITLE}"`;
                 domElements.diplomaParticipantName.textContent = `${state.currentUser.name || ''} ${state.currentUser.surname || ''}`.trim();
                 domElements.diplomaDate.textContent = state.currentUser.completed_date;
             }
        }

        async function downloadDiploma() {
            domElements.diplomaLoading.classList.remove('hidden');
            domElements.downloadDiplomaBtn.disabled = true;
            try {
                const diplomaElement = document.getElementById('diploma-content');
                const canvas = await html2canvas(diplomaElement, {
                    scale: 3,
                    backgroundColor: '#fdfbf4',
                    useCORS: true 
                });
                const pdf = new jspdf.jsPDF({
                    orientation: 'landscape',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(`Diploma_${state.currentUser.name}_${state.currentUser.surname}_${COURSE_TITLE.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
            } catch (error) {
                console.error("Error al generar PDF:", error);
                showMessage('Error al generar el diploma en PDF.', 'error');
            } 
            finally {
                domElements.diplomaLoading.classList.add('hidden');
                domElements.downloadDiplomaBtn.disabled = false;
            }
        }
        
        function restartCourse(fullRestart = true) {
             if (fullRestart) {
                 localStorage.removeItem('blatorh_course_email');
                 localStorage.removeItem('blatorh_course_title');
                 state.currentUser = null;
                 window.location.reload();
             } else { startQuiz(); }
        }
        
        async function loadApprovedUsers() {
            try {
                const { data, error } = await supabaseClient
                    .from('users_progress')
                    .select('name, surname, email, quiz_score, completed_date')
                    .eq('approved', true)
                    .order('completed_date', { ascending: false });

                if (error) throw error;

                domElements.approvedUsersTableBody.innerHTML = data.map(user => `
                    <tr class="border-b border-slate-600 hover:bg-slate-700">
                        <td class="py-3 px-6 text-left">${user.name || ''}</td>
                        <td class="py-3 px-6 text-left">${user.surname || ''}</td>
                        <td class="py-3 px-6 text-left">${user.email}</td>
                        <td class="py-3 px-6 text-left">${user.quiz_score}%</td>
                        <td class="py-3 px-6 text-left">${user.completed_date}</td>
                    </tr>
                `).join('');
            } catch (err) {
                showMessage('Error al cargar la lista de aprobados.', 'error');
            }
        }

        function exportApprovedUsersToCsv() {
             const rows = [['Nombre', 'Apellido', 'Email', 'Score', 'Fecha']];
             const tableRows = domElements.approvedUsersTableBody.querySelectorAll('tr');
             tableRows.forEach(row => {
                 const cols = row.querySelectorAll('td');
                 const rowData = Array.from(cols).map(col => `"${col.innerText}"`);
                 rows.push(rowData);
             });
             const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
             const encodedUri = encodeURI(csvContent);
             const link = document.createElement("a");
             link.setAttribute("href", encodedUri);
             link.setAttribute("download", `aprobados_${COURSE_TITLE.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.csv`);
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
        }

        function downloadResourcePdf() {
            window.open(RESOURCE_PDF_URL, '_blank');
        }

        // --- INICIALIZACIÓN Y EVENTOS ---
        async function initializeApp() {
            domElements.loginCourseTitle.textContent = COURSE_TITLE;
            domElements.loginCourseTitleMobile.textContent = COURSE_TITLE;
            domElements.diplomaCourseTitle.textContent = `"${COURSE_TITLE}"`;
            domElements.courseDurationEstimate.textContent = `Duración: ${calculateCourseDuration()} min`;
            initAudioSystem();
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true') {
                showScreen('admin');
                loadApprovedUsers();
                domElements.exportCsvBtn.addEventListener('click', exportApprovedUsersToCsv);
                return;
            }
            const storedEmail = localStorage.getItem('blatorh_course_email');
            const storedCourseTitle = localStorage.getItem('blatorh_course_title');
            if (storedEmail && storedCourseTitle === COURSE_TITLE) {
                try {
                    const { data: user, error } = await supabaseClient.from('users_progress').select('*').eq('email', storedEmail).eq('course_title', COURSE_TITLE).single();
                    if (error && error.code !== 'PGRST116') throw error;
                    if (user) {
                        state.currentUser = user;
                        if (user.approved) { showScreen('diploma'); updateDiplomaContent(); } 
                        else { showScreen('course'); state.currentChapterIndex = user.progress || 0; loadChapter(); }
                    } else { localStorage.clear(); showScreen('login'); }
                } catch (err) { showMessage('Error al cargar tu progreso. Por favor, inicia sesión de nuevo.', 'error'); localStorage.clear(); showScreen('login'); }
            } else { showScreen('login'); }
        }
        
        domElements.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            unlockAudio();
            const btn = domElements.loginSubmitBtn;
            btn.disabled = true; btn.querySelector('.btn-text').classList.add('hidden'); btn.querySelector('.btn-loader').classList.remove('hidden');
            const name = domElements.nameInput.value.trim(); const surname = domElements.surnameInput.value.trim(); const email = domElements.emailInput.value.trim();
            try {
                const { data: existingUser, error } = await supabaseClient.from('users_progress').select('*').eq('email', email).eq('course_title', COURSE_TITLE).single();
                if (error && error.code !== 'PGRST116') throw error;
                state.currentUser = existingUser ? { ...existingUser, name, surname } : { id: crypto.randomUUID(), name, surname, email, course_title: COURSE_TITLE, progress: 0, quiz_score: null, completed_date: null, approved: false };
                await saveUserProgressToSupabase(state.currentUser);
                localStorage.setItem('blatorh_course_email', email); localStorage.setItem('blatorh_course_title', COURSE_TITLE);
                if (state.currentUser.approved) { showScreen('diploma'); updateDiplomaContent(); } 
                else { showScreen('course'); state.currentChapterIndex = state.currentUser.progress || 0; loadChapter(); }
            } catch (err) { showMessage(`Error en el ingreso: ${err.message}`, 'error'); } 
            finally { btn.disabled = false; btn.querySelector('.btn-text').classList.remove('hidden'); btn.querySelector('.btn-loader').classList.add('hidden'); }
        });

        domElements.listenBtn.addEventListener('click', handleListen);
        domElements.nextBtn.addEventListener('click', () => { 
            if (state.autoPlayTimeout) clearTimeout(state.autoPlayTimeout);
            state.currentChapterIndex++; 
            loadChapter(); 
        });
        domElements.prevQuestionBtn.addEventListener('click', () => { if(state.currentQuestionIndex > 0) { state.currentQuestionIndex--; renderQuestion(); } });
        domElements.nextQuestionBtn.addEventListener('click', () => { if(state.userAnswers[state.currentQuestionIndex] !== null && state.currentQuestionIndex < quizQuestions.length - 1) { state.currentQuestionIndex++; renderQuestion(); }});
        domElements.submitQuizBtn.addEventListener('click', submitQuiz);
        domElements.restartQuizBtn.addEventListener('click', () => restartCourse(false));
        domElements.diplomaBtn.addEventListener('click', () => { showScreen('diploma'); updateDiplomaContent(); });
        domElements.downloadDiplomaBtn.addEventListener('click', downloadDiploma);
        domElements.restartCourseBtn.addEventListener('click', () => restartCourse(true));
        
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>